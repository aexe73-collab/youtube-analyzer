const analyzeLinks = async () => {
    const valid = links.filter(l => l.trim());
    if (valid.length === 0) {
        setError('Please enter at least one YouTube link');
        return;
    }

    setError('');
    setResults('');
    setLoading(true);

    try {
        const transcripts = [];

        for (let i = 0; i < valid.length; i++) {
            setProgress(`ðŸ“¥ Fetching video ${i + 1} of ${valid.length}...`);
            const videoId = extractVideoId(valid[i]);
            
            if (!videoId) {
                throw new Error(
                    `âŒ Invalid YouTube URL: ${valid[i]}\n\n` +
                    `Please use format:\n` +
                    `â€¢ https://youtube.com/watch?v=VIDEO_ID\n` +
                    `â€¢ https://youtu.be/VIDEO_ID\n` +
                    `â€¢ VIDEO_ID (11 characters)`
                );
            }
            
            try {
                // Fetch video metadata
                const metadataResponse = await fetch(
                    `https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=AIzaSyDummyKeyReplaceLater`
                );
                const metadataData = await metadataResponse.json();
                
                let title = 'Unknown Title';
                let channel = 'Unknown Channel';
                
                if (metadataData.items && metadataData.items.length > 0) {
                    title = metadataData.items[0].snippet.title;
                    channel = metadataData.items[0].snippet.channelTitle;
                }
                
                // Fetch transcript
                const transcript = await fetchTranscript(videoId);
                
                transcripts.push({ 
                    url: valid[i], 
                    videoId, 
                    transcript,
                    title,
                    channel
                });
            } catch (transcriptError) {
                throw new Error(
                    `âŒ Could not fetch transcript for video ${i + 1}\n\n` +
                    `Video: ${valid[i]}\n\n` +
                    `Possible reasons:\n` +
                    `â€¢ Video doesn't have captions/subtitles enabled\n` +
                    `â€¢ Captions are disabled by the creator\n` +
                    `â€¢ Video is age-restricted or private\n` +
                    `â€¢ Video has been deleted\n\n` +
                    `âœ… How to check if a video has captions:\n` +
                    `1. Open the video on YouTube\n` +
                    `2. Look for the CC (closed captions) button\n` +
                    `3. Click it - if captions appear, the video can be analyzed\n` +
                    `4. If there's no CC button or it says "unavailable", try a different video\n\n` +
                    `ðŸ’¡ Tip: Most professional content creators enable captions on their videos!`
                );
            }
        }

        setProgress('ðŸ¤– Analyzing with Claude AI...');

        // Build report header
        const reportHeader = transcripts.map((t, i) => 
            `## Video ${i + 1}\n` +
            `**Title:** ${t.title}\n` +
            `**Channel:** ${t.channel}\n` +
            `**Link:** ${t.url}\n`
        ).join('\n');

        const transcriptText = transcripts.map((t, i) => 
            `### VIDEO ${i + 1} TRANSCRIPT:\n${t.transcript}`
        ).join('\n\n---\n\n');

        const prompt = transcripts.length === 1
            ? `You are analyzing a YouTube video. Create a professional insights report.

${reportHeader}

---

Based on the transcript, provide:

## Key Insights
- Main concepts, strategies and lessons
- Specific examples and data points mentioned
- Unique or surprising perspectives

## Actionable Takeaways
- What viewers can implement immediately
- Step-by-step processes mentioned
- Tools or frameworks discussed

## Best Quotes
- Most impactful quotes with context

---

${transcriptText}`
            : `You are analyzing multiple YouTube videos. Create a professional comparative insights report.

${reportHeader}

---

Based on the transcripts, provide:

## Consensus Views
- What all videos agree on
- Common themes and strategies

## Unique Perspectives
- What each video uniquely offers
- Contradicting viewpoints

## Comparative Analysis
- Which video excels in what areas
- How they complement each other

## Synthesized Best Practices
- Combined wisdom from all sources
- Recommended viewing order

---

${transcriptText}`;

        const analysis = await analyzeWithClaude(prompt);
        
        // Prepend the header to results
        const formattedResults = `# YouTube Insights Report\n\n${reportHeader}\n---\n\n${analysis}`;
        setResults(formattedResults);

    } catch (err) {
        setError(err.message);
    } finally {
        setLoading(false);
        setProgress('');
    }
};
```

4. Commit

---

## **Wait - You Need to Add YouTube API Key!**

You already have a YouTube API key from earlier. Add it to Vercel:

1. Vercel â†’ Settings â†’ Environment Variables
2. Add (if not already there):
   - **Key**: `YOUTUBE_API_KEY`
   - **Value**: Your Google API key (starts with `AIza...`)
   - Check all environments
3. Save
4. **Redeploy**

---

**After deployment, the output will look like:**
```
# YouTube Insights Report

## Video 1
**Title:** "How to Build a Million Dollar Business"
**Channel:** My First Million
**Link:** https://youtube.com/watch?v=...

---

## Key Insights
- [Analysis here]

## Actionable Takeaways
- [Analysis here]
