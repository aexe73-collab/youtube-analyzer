const analyzeLinks = async () => {
    const valid = links.filter(l => l.trim());
    if (valid.length === 0) {
        setError('Please enter at least one YouTube link');
        return;
    }

    setError('');
    setResults('');
    setLoading(true);

    try {
        const transcripts = [];

        for (let i = 0; i < valid.length; i++) {
            setProgress(`ðŸ“¥ Fetching video ${i + 1} of ${valid.length}...`);
            const videoId = extractVideoId(valid[i]);
            
            if (!videoId) {
                throw new Error(`Invalid YouTube URL: ${valid[i]}`);
            }
            
            // Fetch video metadata (title & channel)
            let title = 'Unknown Title';
            let channel = 'Unknown Channel';
            
            try {
                const metadataResponse = await fetch(
                    `/api/metadata?videoId=${videoId}`
                );
                const metadata = await metadataResponse.json();
                if (metadata.title) title = metadata.title;
                if (metadata.channel) channel = metadata.channel;
            } catch (err) {
                console.log('Could not fetch metadata, using defaults');
            }
            
            // Fetch transcript
            const transcript = await fetchTranscript(videoId);
            transcripts.push({ url: valid[i], videoId, transcript, title, channel });
        }

        setProgress('ðŸ¤– Analyzing with Claude AI...');

        const reportHeader = transcripts.map((t, i) => 
            `## Video ${i + 1}\n**Title:** ${t.title}\n**Channel:** ${t.channel}\n**Link:** ${t.url}`
        ).join('\n\n');

        const transcriptText = transcripts.map((t, i) => 
            `VIDEO ${i + 1}: ${t.url}\n\nTRANSCRIPT:\n${t.transcript}`
        ).join('\n\n---\n\n');

        const prompt = transcripts.length === 1
            ? `You are analyzing a YouTube video. Create a professional insights report.

${reportHeader}

---

Based on the transcript, provide:

## Key Insights
- Main concepts, strategies and lessons
- Specific examples and data points mentioned
- Unique or surprising perspectives

## Actionable Takeaways
- What viewers can implement immediately
- Step-by-step processes mentioned
- Tools or frameworks discussed

## Best Quotes
- Most impactful quotes with context

TRANSCRIPT:
${transcriptText}`
            : `You are analyzing multiple YouTube videos. Create a professional comparative insights report.

${reportHeader}

---

Based on the transcripts, provide:

## Consensus Views
- What all videos agree on
- Common themes and strategies

## Unique Perspectives
- What each video uniquely offers
- Contradicting viewpoints

## Comparative Analysis
- Which video excels in what areas
- How they complement each other

## Synthesized Best Practices
- Combined wisdom from all sources
- Recommended viewing order

TRANSCRIPTS:
${transcriptText}`;

        const analysis = await analyzeWithClaude(prompt);
        const formattedResults = `# YouTube Insights Report\n\n${reportHeader}\n\n---\n\n${analysis}`;
        setResults(formattedResults);

    } catch (err) {
        setError(err.message);
    } finally {
        setLoading(false);
        setProgress('');
    }
};
